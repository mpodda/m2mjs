<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
  layout:decorator="layout-m2m-js">

<head>
	<title>Simple Form</title>
</head>

 <body>
 
  	<div layout:fragment="content">
  	
		<h2>Simple Edit Form</h2>
		
		<div id="formPlaceHolder">
		
		</div>
		
		<div class="row">
		    <div class="btn-toolbar">
		        <div class="btn btn-primary" id="btnSaveData"><i class="icon-save"></i> Save</div>
		        <a class="btn btn-success" th:href="@{/simpleGrid}"><i class="icon-list"></i> Return to Grid</a>
		    </div>
		</div>
		
		<script th:inline="javascript">

		(function (){
		    var m2mjs = new M2MJS();
		    var viewForm = new m2mjs.Form();
		
		    var templateLoader = new M2MJS_COMMON.TemplateLoader([[@{/templates/formTemplates}]]);
		    var viewPersonTemplate = templateLoader.loadTemplate("editPersonTemplate");
		
		    document.getElementById("formPlaceHolder").appendChild(viewPersonTemplate);
		
		
		    var nationalities;
		
		    var cNational = {};
		    var cnNational = M2MJS_COMMON.Connection(cNational);
		
		    cNational.config({
		        url: [[@{/nationalities/}]],
		        method: "GET",
		        async: false
		    }).connect();
		
		    nationalities = cNational.getResponseJson();
		    var c = {};
		
		    var cn = M2MJS_COMMON.Connection(c);
		
		    c.config({
		        url: [[@{/person/} + ${id}]],
		        method : "GET",
		        async: true
		    }).connect();
		
		
		    c.onResponse = function () {
		        var results = c.getResponseJson();
		
		        renderForm(results);
		    }
		
		    function renderForm(person) {
		        viewForm.addComponent(new m2mjs.Component("id", document.getElementById("personId")));
		        viewForm.addComponent(new m2mjs.Component("name", document.getElementById("personName")));
		        viewForm.addComponent(new m2mjs.Component("gender", new RadioSet(document.getElementsByName("personGender"))));
		
		        var nationalitySelectComponent = new SelectComponent(document.getElementById("personNationality"));
		        nationalitySelectComponent.renderChoices(nationalities, "id", "description");
		        viewForm.addComponent(new m2mjs.Component("nationality", nationalitySelectComponent));
		
		        viewForm.addComponent(new m2mjs.Component("active", new ActivationButton (document.getElementById("personActive"))));
		        viewForm.addComponent(new m2mjs.Component("comments", document.getElementById("personComments")));
		
		        viewForm.setModelObject(person);
		    }
		
		    document.onreadystatechange = function () {
		        if (document.readyState == "complete") {
		            var xBrowser = new M2MJS_COMMON.XBrowser();
		
		            xBrowser.addHandler(document.getElementById("btnSaveData"), "click", function onClick(e) {
		                var cSave = {};
		
		                var cnSave = M2MJS_COMMON.Connection(cSave);

		                cSave.config({
		                    url: [[@{/savePerson}]],
		                    method : "POST",
		                    async: true,
		                    data: JSON.stringify(viewForm.getModelObject())
		                }).connect();
		
		                cSave.onResponse = function () {
		                    var results = cSave.getResponseJson();
		
		                    alert("Saved successfully");
		                }
		
		                cSave.onError = function () {
		
		                    alert("Error Saving Person: " + cSave.status);
		                }
		            });
		        }
		    }
		})();
		</script>  	
  	
	</div>
	
</body>
</html>  	
  	